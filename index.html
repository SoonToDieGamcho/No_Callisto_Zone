<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fan Game Final Rev2</title>
    <style>
        @font-face {
            font-family: 'Escoredream';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-5Medium.woff') format('woff');
            font-weight: 500;
            font-display: swap;
        }

        body {
            font-family: 'Escoredream', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url('images/bg.png') no-repeat center center;
            background-size: cover;
            touch-action: manipulation; 
        }

        /* 배경 색상 오버레이 */
        #bg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1; 
        }

        /* 배경 상태 클래스 (하늘색 계열 통일, 알파값 구분) */
        .bg-normal { background-color: transparent; }
        .bg-good { background-color: #3DFFEA; opacity: 0.2; }
        .bg-perfect { background-color: #3DFFEA; opacity: 0.4; }
        .bg-bonus { background-color: #63F2FF; opacity: 0.6; }
        .bg-miss { background-color: #3DFFEA; opacity: 0.05; }

        /* 화이트 플래시 (클리어) */
        .flash-effect {
            animation: flash-bg 0.3s ease-out;
        }
        @keyframes flash-bg {
            0% { background-color: #fff; }
            50% { background-color: #888; }
            100% { background-color: transparent; } 
        }

        /* 레드 플래시 (게임오버) */
        .flash-fail {
            animation: flash-fail-bg 0.5s ease-out;
        }
        @keyframes flash-fail-bg {
            0% { background-color: #ff0000; }
            100% { background-color: transparent; }
        }

        #game-container {
            width: 800px;
            height: 500px;
            position: relative;
            background: url('images/box.png') no-repeat center center;
            background-size: 100% 100%; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }

        #stage-info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 28px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
            z-index: 10;
        }

        .field-track {
            position: relative;
            width: 90%;
            height: 80px;
            background: rgba(0, 0, 0, 0.3); 
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px;
            margin-bottom: 20px; 
            overflow: visible; 
            z-index: 5; 
        }

        .obj-image {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
        }

        #img-c {
            left: -20px; 
            width: 100px; 
            height: auto;
        }

        /* 3. C 이펙트 크기 240% 확대 */
        #effect-c {
            position: absolute;
            left: -50px;
            top: 50%;
            /* 기존 중앙 정렬 + 2.4배 확대 적용 */
            transform: translateY(-50%) scale(2.4);
            width: 160px;
            height: 160px;
            background: url('images/ef.png') no-repeat center center;
            background-size: contain;
            z-index: 15;
            opacity: 0.2;
            transition: opacity 0.1s;
            pointer-events: none;
        }

        #img-b {
            right: -20px;
            width: 80px;
            height: auto;
        }

        #player-a {
            width: 110px; 
            height: auto;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            transition: left 0.1s linear;
        }

        .gauge-container {
            position: relative;
            width: 70%;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.3);
            overflow: hidden;
            z-index: 10;
            margin-bottom: 20px; 
        }

        #gauge-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #3DFFEA, #63F2FF);
            box-shadow: 0 0 10px #3DFFEA;
            transition: width 0.05s linear;
        }

        #target-line {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: #fff;
            box-shadow: 0 0 8px #fff;
            z-index: 5;
        }

        #stats-corner {
            position: absolute;
            bottom: 15px;
            left: 20px;
            text-align: left;
            z-index: 10;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        
        .stat-val { color: #fff; font-weight: bold; }

        #accuracy-text {
            height: 24px;
            margin-bottom: 5px;
            font-size: 20px;
            font-weight: bold;
            color: #aaa; 
            text-shadow: 1px 1px 2px black;
            z-index: 10;
        }

        /* 상단 부유 텍스트 컨테이너 (히트 텍스트 및 게임오버) */
        #floating-text-container {
            position: absolute;
            top: 100px; /* 위치 조정 */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            pointer-events: none;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* 히트 텍스트 애니메이션 */
        .hit-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            animation: floatUpFade 2.0s ease-out forwards;
            text-shadow: 1px 1px 2px black;
        }

        /* 1. 게임 오버 텍스트 스타일 복구 */
        .game-over-title {
            font-size: 60px;
            font-weight: 900;
            color: #ff3333; /* 빨간색 */
            text-shadow: 3px 3px 0 #fff, 0 0 20px #ff0000;
            margin-bottom: 10px;
        }
        .game-over-sub {
            font-size: 24px;
            color: #fff;
            text-shadow: 1px 1px 5px black;
            margin-bottom: 15px;
        }
        
        .stat-bad { color: #ff5252; }   
        .stat-good { color: #4caf50; }  

        @keyframes floatUpFade {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(-30px); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        #action-btn {
            padding: 15px 40px;
            font-size: 20px;
            background: #ff5722;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 0 #bf360c;
            font-family: 'Escoredream', sans-serif;
            z-index: 50; 
            margin-top: 10px;
        }
        #action-btn:active {
            box-shadow: 0 2px 0 #bf360c;
            transform: translateY(3px);
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="bg-overlay"></div>

    <div id="stage-info">STAGE 1</div>
    <div id="floating-text-container"></div>
    
    <div id="stats-corner">
        <div>게이지 감소량: <span id="disp-decay" class="stat-val">1.0x</span></div>
        <div>방해하는 힘: <span id="disp-enemy" class="stat-val">1.0x</span></div>
        <div>판정선 속도: <span id="disp-target" class="stat-val">1.0x</span></div>
        <div>클릭 파워: <span id="disp-click" class="stat-val">1.0x</span></div>
    </div>

    <div id="accuracy-text">READY</div>

    <div class="field-track">
        <div id="effect-c"></div>
        <img src="images/C.png" id="img-c" class="obj-image" alt="C">
        <img src="images/A.png" id="player-a" class="obj-image" alt="A">
        <img src="images/B.png" id="img-b" class="obj-image" alt="B">
    </div>

    <div class="gauge-container">
        <div id="gauge-fill"></div>
        <div id="target-line"></div>
    </div>

    <button id="action-btn">MASH! (SPACE)</button>
</div>

<script>
    const CONFIG = {
        baseDecay: 1.0,         
        decayGrowth: 0.12,      
        baseClick: 16,          
        clickGrowth: 0.5,       
        
        baseEnemySpeed: 0.06,   
        pullPower: 0.5,         
        perfectPullSpeed: 0.6,  
        targetMoveSpeed: 0.2,   
        targetMoveGrowth: 0.1,  
        
        tolerance: 8.5,         
        minActiveGauge: 10,
        
        sustainThreshold: 0.5, 
        sustainBaseMult: 1.3,  
        sustainIncMult: 0.03,  
        sustainInterval: 0.1,
        
        gracePeriod: 0.05 
    };

    let state = {
        stage: 1,
        posA: 50,
        gauge: 0,
        targetPos: 60,
        targetDest: 60,
        isPlaying: false,
        lastTime: 0,
        perfectDuration: 0,
        graceTimer: 0 
    };

    const elBody = document.body;
    const elBgOverlay = document.getElementById('bg-overlay');
    const elPlayerA = document.getElementById('player-a');
    const elGaugeFill = document.getElementById('gauge-fill');
    const elTargetLine = document.getElementById('target-line');
    const elStageInfo = document.getElementById('stage-info');
    const elAccuracyText = document.getElementById('accuracy-text');
    const btnAction = document.getElementById('action-btn');
    const elFloatingContainer = document.getElementById('floating-text-container');
    const elEffectC = document.getElementById('effect-c');
    
    const elDispDecay = document.getElementById('disp-decay');
    const elDispEnemy = document.getElementById('disp-enemy');
    const elDispTarget = document.getElementById('disp-target');
    const elDispClick = document.getElementById('disp-click');

    function getStageStats(stageLevel) {
        return {
            decay: CONFIG.baseDecay + ((stageLevel - 1) * CONFIG.decayGrowth),
            click: CONFIG.baseClick + ((stageLevel - 1) * CONFIG.clickGrowth),
            enemySpeed: CONFIG.baseEnemySpeed + ((stageLevel - 1) * 0.02),
            targetSpeed: CONFIG.targetMoveSpeed + ((stageLevel - 1) * CONFIG.targetMoveGrowth)
        };
    }

    function updateStatsUI() {
        const stats = getStageStats(state.stage);
        elDispDecay.innerText = (stats.decay / CONFIG.baseDecay).toFixed(2) + 'x';
        elDispEnemy.innerText = (stats.enemySpeed / CONFIG.baseEnemySpeed).toFixed(2) + 'x';
        elDispTarget.innerText = (stats.targetSpeed / CONFIG.targetMoveSpeed).toFixed(2) + 'x';
        elDispClick.innerText = (stats.click / CONFIG.baseClick).toFixed(2) + 'x';
    }

    function gameLoop(timestamp) {
        if (!state.isPlaying) return;

        const dt = (timestamp - state.lastTime) / 1000;
        state.lastTime = timestamp;

        const stats = getStageStats(state.stage);

        // 게이지
        if (state.gauge > 0) {
            state.gauge -= stats.decay;
            if (state.gauge < 0) state.gauge = 0;
        }

        // 판정선
        if (Math.abs(state.targetPos - state.targetDest) < 2) {
            state.targetDest = Math.random() * 80 + 15; 
        }
        const direction = state.targetDest > state.targetPos ? 1 : -1;
        state.targetPos += direction * stats.targetSpeed;

        // 판정 계산
        let diff = Math.abs(state.gauge - state.targetPos);
        let rawEfficiency = 0;
        let rawJudgment = "MISS";

        if (state.gauge < CONFIG.minActiveGauge) {
            rawJudgment = "LOW";
        } else {
            if (diff < CONFIG.tolerance) {
                rawJudgment = "PERFECT";
                rawEfficiency = 1;
            } else if (diff < 35) {
                rawJudgment = "GOOD";
                rawEfficiency = 1 - ((diff - CONFIG.tolerance) / (35 - CONFIG.tolerance));
            } else {
                rawJudgment = "MISS";
                rawEfficiency = 0;
            }
        }

        // 보정 로직
        let finalJudgment = rawJudgment;
        if (rawJudgment === "PERFECT") {
            state.graceTimer = CONFIG.gracePeriod;
        } else if (state.graceTimer > 0) {
            state.graceTimer -= dt;
            finalJudgment = "PERFECT";
            rawEfficiency = 1; 
        }

        // 결과 반영
        let displayText = "";
        let displayColor = "#aaa";
        let moveAmount = 0;
        let bgClass = "bg-normal";
        let effectAlpha = 0.2;

        if (finalJudgment === "LOW") {
            displayText = "LOW";
            displayColor = "#888"; 
            moveAmount = stats.enemySpeed;
            state.perfectDuration = 0;
            bgClass = "bg-miss";

        } else if (finalJudgment === "PERFECT") {
            state.perfectDuration += dt;
            let currentPullSpeed = CONFIG.perfectPullSpeed;

            if (state.perfectDuration >= CONFIG.sustainThreshold) {
                const extraTime = state.perfectDuration - CONFIG.sustainThreshold;
                const extraSteps = Math.floor(extraTime / CONFIG.sustainInterval);
                const multiplier = CONFIG.sustainBaseMult + (extraSteps * CONFIG.sustainIncMult);
                currentPullSpeed *= multiplier;

                displayText = `MAX x${multiplier.toFixed(2)}`;
                displayColor = "#00e5ff"; 
                bgClass = "bg-bonus";
                effectAlpha = 0.9;
            } else {
                displayText = "PERFECT";
                displayColor = "#4caf50"; 
                bgClass = "bg-perfect";
                effectAlpha = 0.7;
            }
            moveAmount = -currentPullSpeed;

        } else if (finalJudgment === "GOOD") {
            state.perfectDuration = 0;
            displayText = "GOOD";
            displayColor = "#ffeb3b"; 
            const playerForce = CONFIG.pullPower * rawEfficiency;
            moveAmount = stats.enemySpeed - playerForce;
            bgClass = "bg-good";
            effectAlpha = 0.2 + (rawEfficiency * 0.5);

        } else { // MISS
            state.perfectDuration = 0;
            displayText = "MISS";
            displayColor = "#f44336"; 
            moveAmount = stats.enemySpeed;
            bgClass = "bg-miss";
            effectAlpha = 0.2;
        }

        elAccuracyText.innerText = displayText;
        elAccuracyText.style.color = displayColor;
        elBgOverlay.className = bgClass; 
        elEffectC.style.opacity = effectAlpha;

        state.posA += moveAmount;

        if (state.posA <= 0) winStage();
        else if (state.posA >= 100) gameOver();
        else {
            render();
            state.animationId = requestAnimationFrame(gameLoop);
        }
    }

    function render() {
        let visualPos = state.posA;
        if(visualPos < 0) visualPos = 0;
        if(visualPos > 100) visualPos = 100;

        elPlayerA.style.left = `${visualPos}%`;
        elGaugeFill.style.width = `${state.gauge}%`;
        elTargetLine.style.left = `${state.targetPos}%`;
    }

    function increaseGauge() {
        if (!state.isPlaying) return;
        const stats = getStageStats(state.stage);
        state.gauge += stats.click;
        if (state.gauge > 100) state.gauge = 100;
        elGaugeFill.style.filter = "brightness(1.5)";
        setTimeout(() => elGaugeFill.style.filter = "brightness(1)", 50);
    }

    function startGame() {
        state.isPlaying = true;
        state.posA = 50;
        state.gauge = 0;
        state.stage = 1; 
        state.targetPos = 50;
        state.targetDest = 60;
        state.lastTime = performance.now(); 
        state.perfectDuration = 0; 
        state.graceTimer = 0;

        elStageInfo.innerText = "STAGE 1";
        elFloatingContainer.innerHTML = ''; 
        elAccuracyText.innerText = "START";
        updateStatsUI();
        
        elBody.classList.remove('flash-fail');
        elBody.classList.remove('flash-effect');
        elBgOverlay.className = "bg-normal";

        state.animationId = requestAnimationFrame(gameLoop);
    }

    // 2. 한글 히트 텍스트 확인 완료
    function showFloatingText(prevStats, currStats) {
        elFloatingContainer.innerHTML = ''; 

        const decayRate = (currStats.decay / prevStats.decay).toFixed(2);
        createHitElement(`게이지 감소량: x${decayRate}`, "stat-bad");

        const enemyRate = (currStats.enemySpeed / prevStats.enemySpeed).toFixed(2);
        createHitElement(`방해하는 힘: x${enemyRate}`, "stat-bad");
        
        const targetRate = (currStats.targetSpeed / prevStats.targetSpeed).toFixed(2);
        createHitElement(`판정선 속도: x${targetRate}`, "stat-bad");

        const clickRate = (currStats.click / prevStats.click).toFixed(2);
        createHitElement(`클릭 파워: x${clickRate}`, "stat-good");
    }

    function createHitElement(text, className) {
        const div = document.createElement('div');
        div.className = `hit-text ${className}`;
        div.innerText = text;
        elFloatingContainer.appendChild(div);
    }

    function winStage() {
        cancelAnimationFrame(state.animationId);

        const prevStats = getStageStats(state.stage);
        state.stage++;
        const currStats = getStageStats(state.stage);
        showFloatingText(prevStats, currStats);

        elStageInfo.innerText = `STAGE ${state.stage}`;
        updateStatsUI();

        elBody.classList.remove('flash-fail');
        elBody.classList.remove('flash-effect');
        void elBody.offsetWidth;
        elBody.classList.add('flash-effect');
        
        elBgOverlay.className = "bg-normal";

        state.posA = 50; 
        state.gauge = 0;
        state.perfectDuration = 0;
        state.lastTime = performance.now();

        render();
        state.animationId = requestAnimationFrame(gameLoop);
    }

    // 1. 게임 오버 UI 복구
    function gameOver() {
        state.isPlaying = false;
        cancelAnimationFrame(state.animationId);

        elFloatingContainer.innerHTML = '';
        // 판정 텍스트는 숨김 처리
        elAccuracyText.innerText = "";

        // 큰 게임오버 타이틀 생성
        const titleDiv = document.createElement('div');
        titleDiv.className = 'game-over-title';
        titleDiv.innerText = 'GAME OVER';
        
        const subDiv = document.createElement('div');
        subDiv.className = 'game-over-sub';
        subDiv.innerText = `기록: STAGE ${state.stage}`;

        elFloatingContainer.appendChild(titleDiv);
        elFloatingContainer.appendChild(subDiv);

        elBody.classList.remove('flash-effect');
        elBody.classList.remove('flash-fail');
        void elBody.offsetWidth;
        elBody.classList.add('flash-fail');
        
        btnAction.innerText = "RESTART";
    }

    btnAction.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        handleInput();
    });
    btnAction.addEventListener('touchstart', (e) => {
        e.stopPropagation();
        e.preventDefault();
        handleInput();
    });

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            handleInput();
        }
    });

    function handleInput() {
        if (!state.isPlaying) {
            startGame();
            btnAction.innerText = "MASH!";
        } else {
            increaseGauge();
        }
    }

    updateStatsUI();
    render();

</script>
</body>
</html>
